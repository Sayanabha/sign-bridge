<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0A0A0F" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>SignBridge â€” Live View</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;1,9..144,300&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0A0A0F;
      --surface: #111118;
      --panel:   #1A1A24;
      --border:  #2A2A38;
      --text:    #E8E6FF;
      --muted:   #6B6B8A;
      --accent:  #7C6AF7;
      --glow:    #A89BFA;
      --live:    #22C55E;
      --danger:  #EF4444;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Fraunces', Georgia, serif;
      overflow: hidden;
    }

    /* â”€â”€ Layout â”€â”€ */
    #app {
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header bar â”€â”€ */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    #header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #logo {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      letter-spacing: 1px;
    }

    #live-badge {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 20px;
      background: var(--live) + '22';
      border: 1px solid var(--live);
      background: rgba(34, 197, 94, 0.15);
    }

    #live-badge.visible { display: flex; }

    #live-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--live);
      animation: pulse 1.4s infinite;
    }

    #live-text {
      font-size: 10px;
      color: var(--live);
      font-family: 'DM Mono', monospace;
    }

    #topic-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 20px;
      background: rgba(124, 106, 247, 0.15);
      color: var(--glow);
      border: 1px solid rgba(124, 106, 247, 0.3);
      font-family: 'DM Mono', monospace;
      display: none;
    }

    #topic-badge.visible { display: block; }

    /* â”€â”€ Connection state â”€â”€ */
    #connecting {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 40px;
      text-align: center;
    }

    #connecting.hidden { display: none; }

    .spinner {
      width: 40px; height: 40px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    #connect-text {
      font-size: 16px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    /* â”€â”€ Main content â”€â”€ */
    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      display: none;
    }

    #content.visible { display: flex; }

    /* â”€â”€ Caption area â”€â”€ */
    #caption-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .caption-entry {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 18px;
      animation: slideIn 0.3s ease;
    }

    .caption-entry.latest {
      border-color: rgba(124, 106, 247, 0.4);
      background: rgba(124, 106, 247, 0.08);
    }

    .caption-text {
      font-size: 18px;
      line-height: 1.6;
      color: var(--text);
      font-weight: 300;
    }

    .caption-meta {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }

    .caption-time {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .caption-cleaned {
      font-size: 9px;
      color: var(--live);
      font-family: 'DM Mono', monospace;
    }

    /* â”€â”€ Sign queue strip â”€â”€ */
    #sign-strip {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      overflow-x: auto;
      display: flex;
      gap: 8px;
      align-items: center;
      -webkit-overflow-scrolling: touch;
    }

    #sign-strip-label {
      font-size: 9px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      white-space: nowrap;
      margin-right: 4px;
      flex-shrink: 0;
    }

    .sign-token {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      font-family: 'DM Mono', monospace;
      white-space: nowrap;
      flex-shrink: 0;
      animation: tokenPop 0.2s ease;
    }

    .sign-token.known {
      background: rgba(124, 106, 247, 0.2);
      color: var(--glow);
      border: 1px solid rgba(124, 106, 247, 0.4);
    }

    .sign-token.fingerspell {
      background: rgba(107, 107, 138, 0.15);
      color: var(--muted);
      border: 1px solid var(--border);
    }

    /* â”€â”€ Coverage bar â”€â”€ */
    #coverage-bar {
      height: 2px;
      background: var(--border);
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    #coverage-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.8s ease;
      width: 0%;
    }

    /* â”€â”€ Waiting state â”€â”€ */
    #waiting {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 40px;
      text-align: center;
    }

    #waiting.hidden { display: none; }

    #waiting-icon {
      font-size: 48px;
      animation: float 3s ease-in-out infinite;
    }

    #waiting-text {
      font-size: 15px;
      color: var(--muted);
      line-height: 1.7;
    }

    /* â”€â”€ Animations â”€â”€ */
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
    @keyframes spin { to{transform:rotate(360deg)} }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes tokenPop {
      from { opacity: 0; transform: scale(0.85); }
      to   { opacity: 1; transform: scale(1); }
    }
    @keyframes float {
      0%,100%{ transform: translateY(0); }
      50%    { transform: translateY(-8px); }
    }

    /* â”€â”€ Scrollbar â”€â”€ */
    #caption-area::-webkit-scrollbar { width: 3px; }
    #caption-area::-webkit-scrollbar-track { background: transparent; }
    #caption-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    #sign-strip::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <div id="header">
    <div id="header-left">
      <span id="logo">SIGNBRIDGE</span>
      <div id="live-badge">
        <div id="live-dot"></div>
        <span id="live-text">LIVE</span>
      </div>
    </div>
    <span id="topic-badge"></span>
  </div>

  <!-- Connecting state -->
  <div id="connecting">
    <div class="spinner"></div>
    <span id="connect-text">Connecting to session...</span>
  </div>

  <!-- Main content (shown after connect) -->
  <div id="content">

    <!-- Waiting for speech -->
    <div id="waiting">
      <div id="waiting-icon">ðŸ¤Ÿ</div>
      <p id="waiting-text">Connected. Waiting for the presenter to start speaking...</p>
    </div>

    <!-- Caption scroll area -->
    <div id="caption-area" style="display:none"></div>

    <!-- Coverage bar -->
    <div id="coverage-bar">
      <div id="coverage-fill"></div>
    </div>

    <!-- Sign token strip -->
    <div id="sign-strip">
      <span id="sign-strip-label">SIGNS</span>
    </div>

  </div>
</div>

<script>
const serverUrl = window.location.protocol + '//' + window.location.hostname + ':3001';
const socket = io(serverUrl, { transports: ['websocket', 'polling'] });
  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = id => document.getElementById(id);
  const connecting = $('connecting');
  const content    = $('content');
  const waiting    = $('waiting');
  const captionArea = $('caption-area');
  const liveBadge  = $('live-badge');
  const topicBadge = $('topic-badge');
  const coverageFill = $('coverage-fill');
  const signStrip  = $('sign-strip');

  // â”€â”€ Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  socket.on('connect', () => {
    connecting.classList.add('hidden');
    content.classList.add('visible');
    // Tell server this is a viewer (read-only, no processing)
    socket.emit('viewer-join');
  });

  socket.on('disconnect', () => {
    liveBadge.classList.remove('visible');
  });

  // â”€â”€ Captions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  socket.on('caption', (entry) => {
    showCaption(entry.text, entry.timestamp, false);
    liveBadge.classList.add('visible');
    showCaptionArea();
  });

  socket.on('caption-update', (entry) => {
    // Update the last caption with cleaned version
    const entries = captionArea.querySelectorAll('.caption-entry');
    if (entries.length > 0) {
      const last = entries[entries.length - 1];
      last.querySelector('.caption-text').textContent = entry.text;
      const cleaned = last.querySelector('.caption-cleaned');
      if (cleaned) cleaned.style.display = 'inline';
    }

    if (entry.topic) {
      topicBadge.textContent = entry.topic;
      topicBadge.classList.add('visible');
    }
  });

  // â”€â”€ Signs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  socket.on('signs', (data) => {
    updateSignStrip(data.signQueue || []);
    coverageFill.style.width = `${data.coverage || 0}%`;
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showCaptionArea() {
    waiting.classList.add('hidden');
    captionArea.style.display = 'flex';
  }

  function showCaption(text, timestamp, cleaned) {
    // Remove 'latest' from previous
    captionArea.querySelectorAll('.caption-entry').forEach(el => {
      el.classList.remove('latest');
    });

    const div = document.createElement('div');
    div.className = 'caption-entry latest';
    div.innerHTML = `
      <p class="caption-text">${text}</p>
      <div class="caption-meta">
        <span class="caption-time">${new Date(timestamp || Date.now()).toLocaleTimeString()}</span>
        <span class="caption-cleaned" style="display:none">âœ“ cleaned</span>
      </div>
    `;
    captionArea.appendChild(div);
    captionArea.scrollTop = captionArea.scrollHeight;

    // Keep only last 20 captions in DOM
    const all = captionArea.querySelectorAll('.caption-entry');
    if (all.length > 20) all[0].remove();

    captionCount++;
  }

  function updateSignStrip(signQueue) {
    // Clear existing tokens (keep label)
    const label = $('sign-strip-label');
    signStrip.innerHTML = '';
    signStrip.appendChild(label);

    signQueue.slice(0, 12).forEach(s => {
      const span = document.createElement('span');
      span.className = `sign-token ${s.hasVideo ? 'known' : 'fingerspell'}`;
      span.textContent = s.token?.toUpperCase() || '';
      signStrip.appendChild(span);
    });
  }
</script>
</body>
</html>